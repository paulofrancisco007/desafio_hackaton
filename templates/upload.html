<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload de Documentos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    :root {
      --gov-br-blue: #1351b4;
      --gov-br-blue-dark: #0d3a7a;
      --gov-br-yellow: #fbc02d;
      --gov-br-light: #f5f5f5;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--gov-br-light);
    }

    .navbar {
      background-color: var(--gov-br-blue);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .navbar-brand {
      font-weight: 700;
    }
    
    .search-form {
      max-width: 400px;
    }

    .user-info {
      display: flex;
      align-items: center;
      color: white;
      margin-left: 1rem;
    }

    .user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .user-info .dropdown-toggle::after {
      display: none;
    }
    
    .upload-container {
      max-width: 800px;
      margin: 2rem auto;
    }

    .upload-card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .upload-header {
      background-color: var(--gov-br-blue);
      color: white;
      padding: 1.5rem;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    .upload-body {
      padding: 2rem;
      background-color: white;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 1.5rem;
    }

    .upload-area:hover {
      border-color: var(--gov-br-blue);
      background-color: rgba(19, 81, 180, 0.05);
    }

    .upload-icon {
      font-size: 3rem;
      color: var(--gov-br-blue);
      margin-bottom: 1rem;
    }

    .file-preview {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .btn-primary {
      background-color: var(--gov-br-blue);
      border-color: var(--gov-br-blue);
    }

    .btn-primary:hover {
      background-color: var(--gov-br-blue-dark);
      border-color: var(--gov-br-blue-dark);
    }

    .verification-badge {
      background-color: var(--gov-br-yellow);
      color: #333;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    /* Estilo para o seletor de destinatário */
    .recipient-select {
      width: 100%;
      padding: 0.375rem 0.75rem;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
    }

  </style>
</head>

<body>
  <div class="upload-container">
    <div class="upload-card">
      <div class="upload-header">
        <h4><i class="bi bi-cloud-arrow-up me-2"></i>Upload de Documentos</h4>
        <p class="mb-0">Envie documentos digitais ou registre documentos físicos</p>
      </div>
      <div class="upload-body">
        <form id="uploadForm">
          <div class="mb-4">
            <label for="documentType" class="form-label">Tipo de Documento</label>
            <select class="form-select" id="documentType" required>
              <option value="" selected disabled>Selecione o tipo de documento</option>
              <option value="contrato">Contrato</option>
              <option value="edital">Edital</option>
              <option value="lei">Lei</option>
              <option value="portaria">Portaria</option>
              <option value="relatorio">Relatório</option>
              <option value="outros">Outros</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="documentDescription" class="form-label">Descrição do Documento</label>
            <textarea class="form-control" id="documentDescription" rows="3" placeholder="Descreva o conteúdo do documento" required></textarea>
          </div>

          <!-- Novo campo: Destinatário -->
           <div class="mb-4">
              <label for="recipient_id" class="form-label">Destinatário para Assinatura</label>
              <select class="form-select recipient-select" 
                      id="recipient_id" 
                      name="recipient_id" 
                      required>
                <option value="" disabled selected>Selecione um usuário...</option>
                {% for user in users %}
                  <option value="{{ user.id }}">{{ user.nome_completo }}</option>
                {% endfor %}
              </select>
            </div>

          <div class="mb-4">
            <label class="form-label">Origem do Documento</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="documentOrigin" id="digitalOrigin" value="digital" checked>
              <label class="form-check-label" for="digitalOrigin">
                Documento Digital (arquivo)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="documentOrigin" id="physicalOrigin" value="fisico">
              <label class="form-check-label" for="physicalOrigin">
                Documento Físico (digitalizado)
              </label>
            </div>
          </div>

          <div id="digitalUploadSection">
            <div class="upload-area" id="dropArea">
              <div class="upload-icon">
                <i class="bi bi-file-earmark-arrow-up"></i>
              </div>
              <h5>Arraste e solte arquivos aqui</h5>
              <p class="text-muted">ou clique para selecionar</p>
              <input type="file" id="fileInput" class="d-none" multiple>
              <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-folder2-open me-2"></i>Selecionar Arquivos
              </button>
            </div>
            <div id="filePreview" class="file-preview d-none">
              <h6>Arquivos selecionados:</h6>
              <div id="fileList"></div>
            </div>
          </div>

          <div id="physicalUploadSection" class="d-none">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>Para documentos físicos, anexe uma digitalização ou foto de boa qualidade.
            </div>
            <div class="upload-area" id="physicalDropArea">
              <div class="upload-icon">
                <i class="bi bi-camera"></i>
              </div>
              <h5>Digitalize ou fotografe o documento</h5>
              <p class="text-muted">Certifique-se que todas as informações estão legíveis</p>
              <input type="file" id="physicalFileInput" class="d-none" accept="image/*" capture="environment">
              <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('physicalFileInput').click()">
                <i class="bi bi-camera me-2"></i>Abrir Câmera/Arquivo
              </button>
            </div>
            <div id="physicalFilePreview" class="file-preview d-none">
              <h6>Documento digitalizado:</h6>
              <div id="physicalFileList"></div>
            </div>
          </div>

          <div class="mb-4 mt-4">
            <label for="securityPassword" class="form-label">Senha de Confirmação</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock"></i></span>
              <input type="password" class="form-control" id="securityPassword" placeholder="Digite sua senha para confirmar" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div class="form-text">Esta senha confirma que você tem autorização para enviar este documento</div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('upload') }}" class="btn btn-secondary me-md-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Enviar para Assinatura</button>
          </div>

            <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
              <i class="bi bi-arrow-left me-2"></i>Voltar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Alternar entre upload digital e físico
    document.querySelectorAll('input[name="documentOrigin"]').forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'digital') {
          document.getElementById('digitalUploadSection').classList.remove('d-none');
          document.getElementById('physicalUploadSection').classList.add('d-none');
        } else {
          document.getElementById('digitalUploadSection').classList.add('d-none');
          document.getElementById('physicalUploadSection').classList.remove('d-none');
        }
      });
    });

    // Mostrar/ocultar senha
    document.getElementById('togglePassword').addEventListener('click', function() {
      const passwordInput = document.getElementById('securityPassword');
      const icon = this.querySelector('i');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      }
    });

    // Gerenciar upload de arquivos digitais
    const fileInput = document.getElementById('fileInput');
    const dropArea = document.getElementById('dropArea');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');

    fileInput.addEventListener('change', handleFiles);
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.classList.add('bg-light');
    }

    function unhighlight() {
      dropArea.classList.remove('bg-light');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      handleFiles();
    }

    function handleFiles() {
      fileList.innerHTML = '';
      const files = fileInput.files;
      
      if (files.length > 0) {
        filePreview.classList.remove('d-none');
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          
          const fileInfo = document.createElement('div');
          fileInfo.innerHTML = `
            <i class="bi bi-file-earmark-text me-2"></i>
            <strong>${file.name}</strong> (${formatFileSize(file.size)})
          `;
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-sm btn-outline-danger';
          removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
          removeBtn.onclick = () => removeFile(i);
          
          fileItem.appendChild(fileInfo);
          fileItem.appendChild(removeBtn);
          fileList.appendChild(fileItem);
        }
      } else {
        filePreview.classList.add('d-none');
      }
    }

    function removeFile(index) {
      const dt = new DataTransfer();
      const files = fileInput.files;
      
      for (let i = 0; i < files.length; i++) {
        if (i !== index) {
          dt.items.add(files[i]);
        }
      }
      
      fileInput.files = dt.files;
      handleFiles();
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Gerenciar upload de documentos físicos
    const physicalFileInput = document.getElementById('physicalFileInput');
    const physicalFilePreview = document.getElementById('physicalFilePreview');
    const physicalFileList = document.getElementById('physicalFileList');

    physicalFileInput.addEventListener('change', handlePhysicalFiles);

    function handlePhysicalFiles() {
      physicalFileList.innerHTML = '';
      const files = physicalFileInput.files;
      
      if (files.length > 0) {
        physicalFilePreview.classList.remove('d-none');
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          
          const fileInfo = document.createElement('div');
          fileInfo.innerHTML = `
            <i class="bi bi-image me-2"></i>
            <strong>${file.name}</strong> (${formatFileSize(file.size)})
          `;
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-sm btn-outline-danger';
          removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
          removeBtn.onclick = () => removePhysicalFile(i);
          
          fileItem.appendChild(fileInfo);
          fileItem.appendChild(removeBtn);
          physicalFileList.appendChild(fileItem);
          
          // Mostrar pré-visualização da imagem
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.createElement('img');
              preview.src = e.target.result;
              preview.style.maxWidth = '100%';
              preview.style.maxHeight = '200px';
              preview.style.marginTop = '10px';
              fileItem.insertBefore(preview, removeBtn);
            };
            reader.readAsDataURL(file);
          }
        }
      } else {
        physicalFilePreview.classList.add('d-none');
      }
    }

    function removePhysicalFile(index) {
      const dt = new DataTransfer();
      const files = physicalFileInput.files;
      
      for (let i = 0; i < files.length; i++) {
        if (i !== index) {
          dt.items.add(files[i]);
        }
      }
      
      physicalFileInput.files = dt.files;
      handlePhysicalFiles();
    }

    // Validação do formulário
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const documentType = document.getElementById('documentType').value;
      const documentDescription = document.getElementById('documentDescription').value;
      const recipient = document.getElementById('recipient_id').value;  // corrigido
      const securityPassword = document.getElementById('securityPassword').value;
      const documentOrigin = document.querySelector('input[name="documentOrigin"]:checked').value;

      if (!documentType) {
        alert('Selecione o tipo de documento');
        return false;
      }

      if (!documentDescription) {
        alert('Descreva o conteúdo do documento');
        return false;
      }

      if (!recipient) {
        alert('Selecione o destinatário do documento');
        return false;
      }

      if (documentOrigin === 'digital' && fileInput.files.length === 0) {
        alert('Selecione pelo menos um arquivo para upload');
        return false;
      }

      if (documentOrigin === 'fisico' && physicalFileInput.files.length === 0) {
        alert('Anexe a digitalização do documento físico');
        return false;
      }

      if (!securityPassword) {
        alert('Digite a senha de confirmação');
        return false;
      }

  // Se passou em todas as validações, ENVIAR de verdade:
  this.submit();  // <- Aqui faz o submit real
});


    // Função auxiliar para obter o nome do destinatário
    function getRecipientName(value) {
      const recipients = {
        'secretaria_saude': 'Secretaria da Saúde',
        'secretaria_educacao': 'Secretaria de Educação',
        'prefeitura': 'Prefeitura Municipal',
        'camara': 'Câmara de Vereadores',
        'procuradoria': 'Procuradoria Geral',
        'outro': 'Outro Órgão'
      };
      return recipients[value] || 'Destinatário Desconhecido';
    }
  </script>
</body>
</html>